apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd

# CIS 4.2.5
streamingConnectionIdleTimeout: {{ kubernetes_streamingconnectionidletimeout}}
# CIS 4.2.10
rotateCertificates: true
# CIS 4.2.11
serverTLSBootstrap: true
# CIS 4.2.12
tlsCipherSuites:
{{ kubernetes_strong_cypher_suites | to_nice_yaml }}
# CIS 4.2.15
podPidsLimit: {{ kubernetes_podpidslimit }}
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
controlPlaneEndpoint: "{{ kubernetes_api_endpoint }}:{{ kubernetes_api_port }}"
controllerManager:
  extraArgs:
    node-cidr-mask-size: "{{ kubernetes_node_cidr_mask_size }}"
    # CIS 1.3.1
    terminated-pod-gc-threshold: "{{ kubernetes_terminated_pod_gc_threshold }}"
    # TODO: Remove this so it goes back to the 1 year default, this is to test cert rotation/expiration
    cluster-signing-duration: "{{ kubernetes_cluster_signing_duration }}"
    # CIS 1.3.2
    profiling: "{{ kubernetes_profiling | upper}}"
networking:
  serviceSubnet: "{{ kubernetes_service_subnet }}"
  podSubnet: "{{ kubernetes_pod_subnet }}"
  dnsDomain: "{{ kubernetes_dns_domain }}"
apiServer:
  extraArgs:
    # CIS 1.2.16
    audit-log-path: {{ kubernetes_audit_log_path }}
    # CIS 1.2.17
    audit-log-maxage: "{{ kubernetes_audit_log_max_age }}"
    # CIS 1.2.18
    audit-log-maxbackup: "{{ kubernetes_audit_log_max_backup }}"
    # CIS 1.2.19
    audit-log-maxsize: "{{ kubernetes_audit_log_max_size }}"
    # CIS 1.2.29
    tls-cipher-suites: "{{ kubernetes_strong_cypher_suites | join(",") }}"
    # CIS 3.2.1
    audit-policy-file: "{{ kubernetes_config_directory }}/audit-policy.yaml"
    # CIS 1.2.6, 1.2.7, 1.2.8
    authorization-mode: Node,RBAC
    # CIS 3.1.1, 3.1.2, 3.1.3
    authentication-config: "{{ kubernetes_config_directory }}/kube-api-authn.yaml"
    # CIS 1.2.11
    enable-admission-plugins: {{ kubernetes_admission_control_plugins | join(",") }}
    # CIS 1.2.27
    encryption-provider-config: "{{ kubernetes_config_directory }}/encryption.yaml"
    encryption-provider-config-automatic-reload: "true"
    # CIS 1.2.5
    kubelet-certificate-authority: "{{ kubernetes_pki_directory }}/ca.crt"
    # CIS 1.2.15
    profiling: "{{ kubernetes_profiling | upper}}"
  certSANs:
  - "{{ kubernetes_api_endpoint }}"
  extraVolumes:
    - name: auth
      hostPath: "{{ kubernetes_config_directory }}/kube-api-authn.yaml"
      mountPath: "{{ kubernetes_config_directory }}/kube-api-authn.yaml"
      readOnly: true
      pathType: File
    - name: encryption-config
      hostPath: "{{ kubernetes_config_directory }}/encryption.yaml"
      mountPath: "{{ kubernetes_config_directory }}/encryption.yaml"
      readOnly: true
      pathType: File
    - name: audit-policy
      hostPath: "{{ kubernetes_config_directory }}/audit-policy.yaml"
      mountPath: "{{ kubernetes_config_directory }}/audit-policy.yaml"
      readOnly: true
      pathType: File
    - name: audit-log
      hostPath: /var/log/apiserver
      mountPath: /var/log/apiserver
      readOnly: false
      pathType: DirectoryOrCreate
  timeoutForControlPlane: 4m0s
scheduler:
  extraArgs:
    authentication-tolerate-lookup-failure: "false"
    # CIS 1.4.1
    profiling: "{{ kubernetes_profiling | upper}}"
clusterName: "{{ kubernetes_cluster_name }}"
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: "ipvs"
# CIS 4.3.1
metricsBindAddress: "127.0.0.1:10249"
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
# skipPhases:
# - addon/kube-proxy
nodeRegistration:
  kubeletExtraArgs:
    cloud-provider: "external"
    node-ip: "{{ ansible_default_ipv4.address}}"
patches:
  directory: {{ kubernetes_config_directory }}/patches
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: UpgradeConfiguration
apply:
  patches:
    directory: {{ kubernetes_config_directory }}/patches
node:
  patches:
    directory: {{ kubernetes_config_directory }}/patches
